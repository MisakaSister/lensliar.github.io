<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¿ç§»å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .step {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .step h3 {
            margin-top: 0;
            color: #007bff;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .success {
            color: #28a745;
            background: #d4edda;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .warning {
            color: #856404;
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .info {
            color: #004085;
            background: #cce7ff;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .progress {
            background: #f1f1f1;
            border-radius: 10px;
            padding: 3px;
            margin: 10px 0;
        }
        
        .progress-bar {
            background: #007bff;
            height: 20px;
            border-radius: 8px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .config-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .config-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ æ•°æ®è¿ç§»å·¥å…·</h1>
        
        <div class="info">
            <strong>è¿ç§»è¯´æ˜ï¼š</strong>
            <p>æ­¤å·¥å…·å°†ç°æœ‰çš„æ‰¹é‡å­˜å‚¨æ•°æ®è¿ç§»åˆ°æ–°çš„å•ç‹¬å­˜å‚¨æ ¼å¼ï¼š</p>
            <ul>
                <li>æ¯ç¯‡æ–‡ç« å­˜å‚¨ä¸ºä¸€ä¸ªç‹¬ç«‹çš„KVå¯¹</li>
                <li>æ¯ç¯‡æ–‡ç« åŒ…å«å®Œæ•´çš„ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€å†…å®¹ã€å›¾ç‰‡ã€é™„ä»¶ç­‰ï¼‰</li>
                <li>æ”¯æŒæ›´ä¸°å¯Œçš„å…ƒæ•°æ®å’ŒSEOä¿¡æ¯</li>
                <li>æä¾›æ›´å¥½çš„æ€§èƒ½å’Œå¹¶å‘æ”¯æŒ</li>
            </ul>
        </div>

        <div class="config-section">
            <h3>ğŸ”§ é…ç½®ä¿¡æ¯</h3>
            <div>
                <label for="apiUrl">APIåœ°å€ï¼š</label>
                <input type="text" id="apiUrl" placeholder="https://your-worker.your-subdomain.workers.dev">
            </div>
            <div>
                <label for="username">ç”¨æˆ·åï¼š</label>
                <input type="text" id="username" placeholder="admin">
            </div>
            <div>
                <label for="password">å¯†ç ï¼š</label>
                <input type="password" id="password" placeholder="è¾“å…¥å¯†ç ">
            </div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 1: å¤‡ä»½ç°æœ‰æ•°æ®</h3>
            <p>é¦–å…ˆè·å–ç°æœ‰æ•°æ®å¹¶åˆ›å»ºå¤‡ä»½</p>
            <button onclick="backupData()">å¤‡ä»½æ•°æ®</button>
            <div id="backupResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 2: æ•°æ®æ ¼å¼è½¬æ¢</h3>
            <p>å°†ç°æœ‰æ•°æ®è½¬æ¢ä¸ºæ–°çš„å­˜å‚¨æ ¼å¼</p>
            <button onclick="convertData()" disabled id="convertBtn">è½¬æ¢æ•°æ®</button>
            <div id="convertResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 3: è¿ç§»æ•°æ®</h3>
            <p>å°†è½¬æ¢åçš„æ•°æ®ä¸Šä¼ åˆ°æ–°çš„å­˜å‚¨æ ¼å¼</p>
            <button onclick="migrateData()" disabled id="migrateBtn">å¼€å§‹è¿ç§»</button>
            <div class="progress hidden" id="migrateProgress">
                <div class="progress-bar" id="migrateProgressBar">0%</div>
            </div>
            <div id="migrateResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 4: éªŒè¯è¿ç§»ç»“æœ</h3>
            <p>æ£€æŸ¥è¿ç§»åçš„æ•°æ®å®Œæ•´æ€§</p>
            <button onclick="verifyMigration()" disabled id="verifyBtn">éªŒè¯æ•°æ®</button>
            <div id="verifyResult"></div>
        </div>

        <div class="log hidden" id="migrationLog"></div>
    </div>

    <script>
        let authToken = '';
        let backupData = null;
        let convertedData = null;
        let migrationResults = [];

        // è·å–APIé…ç½®
        function getApiConfig() {
            return {
                apiUrl: document.getElementById('apiUrl').value.trim(),
                username: document.getElementById('username').value.trim(),
                password: document.getElementById('password').value.trim()
            };
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // è®°å½•æ—¥å¿—
        function log(message) {
            const logContainer = document.getElementById('migrationLog');
            logContainer.classList.remove('hidden');
            logContainer.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            const progressBar = document.getElementById('migrateProgressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
        }

        // ç™»å½•è·å–token
        async function login() {
            const config = getApiConfig();
            
            if (!config.apiUrl || !config.username || !config.password) {
                throw new Error('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®ä¿¡æ¯');
            }

            try {
                const response = await fetch(`${config.apiUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: config.username,
                        password: config.password
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'ç™»å½•å¤±è´¥');
                }

                authToken = result.token;
                log('ç™»å½•æˆåŠŸ');
                
            } catch (error) {
                throw new Error(`ç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        // å¤‡ä»½ç°æœ‰æ•°æ®
        async function backupData() {
            try {
                showMessage('backupResult', 'æ­£åœ¨å¤‡ä»½æ•°æ®...', 'info');
                
                await login();
                
                const config = getApiConfig();
                const response = await fetch(`${config.apiUrl}/content`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('è·å–æ•°æ®å¤±è´¥');
                }

                const data = await response.json();
                backupData = data;
                
                // åˆ›å»ºå¤‡ä»½æ–‡ä»¶
                const backupBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const backupUrl = URL.createObjectURL(backupBlob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = backupUrl;
                downloadLink.download = `backup_${new Date().toISOString().slice(0, 10)}.json`;
                downloadLink.click();
                
                showMessage('backupResult', 
                    `âœ… å¤‡ä»½æˆåŠŸï¼<br>
                    æ–‡ç« æ•°é‡: ${data.articles?.length || 0}<br>
                    å›¾ç‰‡æ•°é‡: ${data.images?.length || 0}<br>
                    å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½`, 'success');
                
                document.getElementById('convertBtn').disabled = false;
                log(`å¤‡ä»½å®Œæˆ - æ–‡ç« : ${data.articles?.length || 0}, å›¾ç‰‡: ${data.images?.length || 0}`);
                
            } catch (error) {
                showMessage('backupResult', `âŒ å¤‡ä»½å¤±è´¥: ${error.message}`, 'error');
                log(`å¤‡ä»½å¤±è´¥: ${error.message}`);
            }
        }

        // è½¬æ¢æ•°æ®æ ¼å¼
        async function convertData() {
            try {
                showMessage('convertResult', 'æ­£åœ¨è½¬æ¢æ•°æ®æ ¼å¼...', 'info');
                
                if (!backupData) {
                    throw new Error('è¯·å…ˆå¤‡ä»½æ•°æ®');
                }

                const articles = backupData.articles || [];
                const images = backupData.images || [];
                
                // è½¬æ¢æ–‡ç« æ•°æ®
                convertedData = articles.map(article => {
                    // æŸ¥æ‰¾ç›¸å…³å›¾ç‰‡
                    const relatedImages = images.filter(img => 
                        img.category === article.category || 
                        img.title.includes(article.title) ||
                        article.content.includes(img.url)
                    );

                    // æ„é€ æ–°çš„æ–‡ç« æ ¼å¼
                    return {
                        id: article.id || `article_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        title: article.title || '',
                        content: article.content || '',
                        summary: article.summary || article.content?.substring(0, 200) || '',
                        category: article.category || '',
                        tags: article.tags || [],
                        
                        // å°é¢å›¾ç‰‡ï¼ˆä½¿ç”¨ç¬¬ä¸€å¼ ç›¸å…³å›¾ç‰‡æˆ–æ–‡ç« ä¸­çš„å›¾ç‰‡ï¼‰
                        coverImage: article.image ? {
                            url: article.image,
                            alt: article.title,
                            caption: ''
                        } : (relatedImages.length > 0 ? {
                            url: relatedImages[0].url,
                            alt: relatedImages[0].title,
                            caption: relatedImages[0].description || ''
                        } : null),
                        
                        // æ–‡ç« ä¸­çš„å›¾ç‰‡é›†åˆ
                        images: relatedImages.map(img => ({
                            id: img.id || `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            url: img.url,
                            alt: img.title || '',
                            caption: img.description || '',
                            width: null,
                            height: null,
                            size: null
                        })),
                        
                        // é™„ä»¶ï¼ˆæš‚æ—¶ä¸ºç©ºï¼‰
                        attachments: [],
                        
                        // å…ƒæ•°æ®
                        author: 'Admin',
                        status: 'published',
                        visibility: 'public',
                        
                        // æ—¶é—´æˆ³
                        createdAt: article.createdAt || article.date || new Date().toISOString(),
                        updatedAt: article.updatedAt || new Date().toISOString(),
                        publishedAt: article.createdAt || article.date || new Date().toISOString(),
                        
                        // SEOä¿¡æ¯
                        seo: {
                            metaTitle: article.title || '',
                            metaDescription: article.summary || article.content?.substring(0, 160) || '',
                            keywords: article.tags || [],
                            slug: generateSlug(article.title || '')
                        },
                        
                        // ç»Ÿè®¡ä¿¡æ¯
                        stats: {
                            views: 0,
                            likes: 0,
                            comments: 0,
                            shares: 0
                        }
                    };
                });

                showMessage('convertResult', 
                    `âœ… æ•°æ®è½¬æ¢æˆåŠŸï¼<br>
                    è½¬æ¢äº† ${convertedData.length} ç¯‡æ–‡ç« <br>
                    æ€»å›¾ç‰‡æ•°: ${images.length}`, 'success');
                
                document.getElementById('migrateBtn').disabled = false;
                log(`æ•°æ®è½¬æ¢å®Œæˆ - ${convertedData.length} ç¯‡æ–‡ç« `);
                
            } catch (error) {
                showMessage('convertResult', `âŒ æ•°æ®è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                log(`æ•°æ®è½¬æ¢å¤±è´¥: ${error.message}`);
            }
        }

        // ç”ŸæˆURLå‹å¥½çš„slug
        function generateSlug(title) {
            return title
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
        }

        // è¿ç§»æ•°æ®
        async function migrateData() {
            try {
                showMessage('migrateResult', 'æ­£åœ¨è¿ç§»æ•°æ®...', 'info');
                
                if (!convertedData) {
                    throw new Error('è¯·å…ˆè½¬æ¢æ•°æ®');
                }

                const progressContainer = document.getElementById('migrateProgress');
                progressContainer.classList.remove('hidden');
                
                const config = getApiConfig();
                const total = convertedData.length;
                let completed = 0;
                
                migrationResults = [];

                // é€ä¸ªè¿ç§»æ–‡ç« 
                for (const article of convertedData) {
                    try {
                        log(`æ­£åœ¨è¿ç§»æ–‡ç« : ${article.title}`);
                        
                        const response = await fetch(`${config.apiUrl}/content`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(article)
                        });

                        const result = await response.json();
                        
                        if (response.ok) {
                            migrationResults.push({
                                id: article.id,
                                title: article.title,
                                status: 'success',
                                message: 'è¿ç§»æˆåŠŸ'
                            });
                            log(`âœ… æ–‡ç« è¿ç§»æˆåŠŸ: ${article.title}`);
                        } else {
                            migrationResults.push({
                                id: article.id,
                                title: article.title,
                                status: 'error',
                                message: result.error || 'è¿ç§»å¤±è´¥'
                            });
                            log(`âŒ æ–‡ç« è¿ç§»å¤±è´¥: ${article.title} - ${result.error}`);
                        }
                        
                    } catch (error) {
                        migrationResults.push({
                            id: article.id,
                            title: article.title,
                            status: 'error',
                            message: error.message
                        });
                        log(`âŒ æ–‡ç« è¿ç§»å¼‚å¸¸: ${article.title} - ${error.message}`);
                    }
                    
                    completed++;
                    updateProgress((completed / total) * 100);
                    
                    // é¿å…è¯·æ±‚è¿‡å¿«
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const successCount = migrationResults.filter(r => r.status === 'success').length;
                const errorCount = migrationResults.filter(r => r.status === 'error').length;
                
                showMessage('migrateResult', 
                    `ğŸ‰ è¿ç§»å®Œæˆï¼<br>
                    æˆåŠŸ: ${successCount} ç¯‡<br>
                    å¤±è´¥: ${errorCount} ç¯‡<br>
                    æ€»è®¡: ${total} ç¯‡`, 
                    errorCount > 0 ? 'warning' : 'success');
                
                document.getElementById('verifyBtn').disabled = false;
                log(`è¿ç§»å®Œæˆ - æˆåŠŸ: ${successCount}, å¤±è´¥: ${errorCount}`);
                
            } catch (error) {
                showMessage('migrateResult', `âŒ è¿ç§»å¤±è´¥: ${error.message}`, 'error');
                log(`è¿ç§»å¤±è´¥: ${error.message}`);
            }
        }

        // éªŒè¯è¿ç§»ç»“æœ
        async function verifyMigration() {
            try {
                showMessage('verifyResult', 'æ­£åœ¨éªŒè¯è¿ç§»ç»“æœ...', 'info');
                
                const config = getApiConfig();
                const response = await fetch(`${config.apiUrl}/content`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('è·å–è¿ç§»åæ•°æ®å¤±è´¥');
                }

                const newData = await response.json();
                const newArticles = newData.articles || [];
                
                // éªŒè¯æ•°æ®å®Œæ•´æ€§
                const originalCount = backupData.articles?.length || 0;
                const newCount = newArticles.length;
                const successCount = migrationResults.filter(r => r.status === 'success').length;
                
                let verificationMessage = `ğŸ“Š éªŒè¯ç»“æœï¼š<br>
                    åŸå§‹æ–‡ç« æ•°: ${originalCount}<br>
                    è¿ç§»æˆåŠŸæ•°: ${successCount}<br>
                    å½“å‰æ–‡ç« æ•°: ${newCount}<br>`;
                
                if (newCount >= successCount) {
                    verificationMessage += `<br>âœ… æ•°æ®éªŒè¯é€šè¿‡ï¼`;
                    showMessage('verifyResult', verificationMessage, 'success');
                } else {
                    verificationMessage += `<br>âš ï¸ æ•°æ®å¯èƒ½ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥ï¼`;
                    showMessage('verifyResult', verificationMessage, 'warning');
                }
                
                // åˆ›å»ºéªŒè¯æŠ¥å‘Š
                const report = {
                    timestamp: new Date().toISOString(),
                    originalCount,
                    migratedCount: successCount,
                    currentCount: newCount,
                    migrationResults,
                    newData: newArticles
                };
                
                const reportBlob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const reportUrl = URL.createObjectURL(reportBlob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = reportUrl;
                downloadLink.download = `migration_report_${new Date().toISOString().slice(0, 10)}.json`;
                downloadLink.click();
                
                log('éªŒè¯å®Œæˆï¼ŒæŠ¥å‘Šå·²ä¸‹è½½');
                
            } catch (error) {
                showMessage('verifyResult', `âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                log(`éªŒè¯å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤å€¼
        window.onload = function() {
            // å¯ä»¥è®¾ç½®é»˜è®¤çš„APIåœ°å€
            // document.getElementById('apiUrl').value = 'https://your-worker.your-subdomain.workers.dev';
        };
    </script>
</body>
</html> 