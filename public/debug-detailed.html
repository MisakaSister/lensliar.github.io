<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¦ç»†è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .step {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .step h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è¯¦ç»†è°ƒè¯•å·¥å…·</h1>
    
    <div class="container">
        <h2>ğŸ” æ­¥éª¤1: è®¤è¯æ£€æŸ¥</h2>
        <div class="step">
            <h4>æ£€æŸ¥ç™»å½•çŠ¶æ€</h4>
            <button class="btn" onclick="checkAuth()">æ£€æŸ¥è®¤è¯</button>
            <div id="authStatus"></div>
        </div>
        <div id="authLog" class="log-area"></div>
    </div>

    <div class="grid">
        <div class="container">
            <h2>ğŸ“¤ æ­¥éª¤2: åˆ›å»ºæµ‹è¯•ç›¸å†Œ</h2>
            <div class="step">
                <h4>åˆ›å»ºç›¸å†Œæ•°æ®</h4>
                <input type="text" id="albumTitle" placeholder="ç›¸å†Œæ ‡é¢˜" value="è°ƒè¯•æµ‹è¯•ç›¸å†Œ">
                <textarea id="albumDesc" placeholder="ç›¸å†Œæè¿°">è¿™æ˜¯ä¸€ä¸ªç”¨äºè°ƒè¯•çš„æµ‹è¯•ç›¸å†Œ</textarea>
                <button class="btn btn-success" onclick="createTestAlbum()">åˆ›å»ºç›¸å†Œ</button>
            </div>
            <div id="createLog" class="log-area"></div>
        </div>

        <div class="container">
            <h2>ğŸ“¥ æ­¥éª¤3: è¯»å–ç›¸å†Œæ•°æ®</h2>
            <div class="step">
                <h4>ä»ä¸åŒæ¥æºè¯»å–</h4>
                <button class="btn" onclick="loadFromAPI()">ä»ç®¡ç†APIè¯»å–</button>
                <button class="btn" onclick="loadFromPublicAPI()">ä»å…¬å¼€APIè¯»å–</button>
                <button class="btn" onclick="compareData()">å¯¹æ¯”æ•°æ®</button>
            </div>
            <div id="loadLog" class="log-area"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ” æ­¥éª¤4: è¯¦ç»†APIè°ƒè¯•</h2>
        <div class="step">
            <h4>APIç«¯ç‚¹æµ‹è¯•</h4>
            <button class="btn" onclick="testAllEndpoints()">æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹</button>
            <button class="btn" onclick="testKVOperations()">æµ‹è¯•KVæ“ä½œ</button>
            <button class="btn btn-danger" onclick="clearAllTestData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
        </div>
        <div id="apiLog" class="log-area"></div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æ­¥éª¤5: æ•°æ®åˆ†æ</h2>
        <div id="dataAnalysis"></div>
    </div>

    <script>
        const API_BASE = 'https://api.wengguodong.com';
        let testResults = {
            auth: null,
            create: null,
            load: null,
            publicAPI: null
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ“';
            element.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function checkAuth() {
            const logEl = document.getElementById('authLog');
            logEl.textContent = '';
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                log('authLog', 'æ²¡æœ‰æ‰¾åˆ°ç™»å½•ä»¤ç‰Œ', 'error');
                setStatus('authStatus', 'âŒ æœªç™»å½•', 'error');
                testResults.auth = false;
                return false;
            }
            
            log('authLog', 'æ‰¾åˆ°ä»¤ç‰Œ: ' + token.substring(0, 30) + '...');
            
            try {
                // æµ‹è¯•å†…å®¹API
                const contentResponse = await fetch(`${API_BASE}/content`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log('authLog', `å†…å®¹APIå“åº”: ${contentResponse.status}`);
                
                // æµ‹è¯•å›¾ç‰‡API
                const imagesResponse = await fetch(`${API_BASE}/images`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log('authLog', `å›¾ç‰‡APIå“åº”: ${imagesResponse.status}`);
                
                if (contentResponse.ok && imagesResponse.ok) {
                    log('authLog', 'æ‰€æœ‰APIè®¤è¯æˆåŠŸ', 'success');
                    setStatus('authStatus', 'âœ… è®¤è¯æˆåŠŸ', 'success');
                    testResults.auth = true;
                    return true;
                } else {
                    log('authLog', 'éƒ¨åˆ†APIè®¤è¯å¤±è´¥', 'error');
                    setStatus('authStatus', 'âŒ è®¤è¯å¤±è´¥', 'error');
                    testResults.auth = false;
                    return false;
                }
            } catch (error) {
                log('authLog', 'è®¤è¯æ£€æŸ¥å¼‚å¸¸: ' + error.message, 'error');
                setStatus('authStatus', 'âŒ è®¤è¯å¼‚å¸¸', 'error');
                testResults.auth = false;
                return false;
            }
        }

        async function createTestAlbum() {
            const logEl = document.getElementById('createLog');
            logEl.textContent = '';
            
            if (!testResults.auth) {
                log('createLog', 'è¯·å…ˆé€šè¿‡è®¤è¯æ£€æŸ¥', 'error');
                return;
            }
            
            const title = document.getElementById('albumTitle').value;
            const description = document.getElementById('albumDesc').value;
            
            const albumData = {
                title: title,
                description: description,
                category: 'è°ƒè¯•åˆ†ç±»',
                tags: ['è°ƒè¯•', 'æµ‹è¯•'],
                images: [
                    {
                        url: 'https://picsum.photos/800/600?random=' + Date.now(),
                        fileName: 'debug_test_' + Date.now() + '.jpg',
                        title: 'è°ƒè¯•æµ‹è¯•å›¾ç‰‡1',
                        alt: 'è°ƒè¯•æµ‹è¯•å›¾ç‰‡1',
                        caption: 'è¿™æ˜¯è°ƒè¯•ç”¨çš„æµ‹è¯•å›¾ç‰‡',
                        size: 1024000,
                        type: 'image/jpeg'
                    },
                    {
                        url: 'https://picsum.photos/800/600?random=' + (Date.now() + 1),
                        fileName: 'debug_test_' + (Date.now() + 1) + '.jpg',
                        title: 'è°ƒè¯•æµ‹è¯•å›¾ç‰‡2',
                        alt: 'è°ƒè¯•æµ‹è¯•å›¾ç‰‡2',
                        caption: 'è¿™æ˜¯è°ƒè¯•ç”¨çš„æµ‹è¯•å›¾ç‰‡',
                        size: 1024000,
                        type: 'image/jpeg'
                    }
                ]
            };
            
            log('createLog', 'å‡†å¤‡åˆ›å»ºç›¸å†Œ...');
            log('createLog', 'APIç«¯ç‚¹: ' + `${API_BASE}/images`);
            log('createLog', 'è¯·æ±‚æ•°æ®: ' + JSON.stringify(albumData, null, 2));
            
            try {
                const response = await fetch(`${API_BASE}/images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(albumData)
                });
                
                log('createLog', `å“åº”çŠ¶æ€: ${response.status}`);
                log('createLog', `å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers), null, 2)}`);
                
                const responseText = await response.text();
                log('createLog', `å“åº”æ–‡æœ¬: ${responseText}`);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('createLog', 'ç›¸å†Œåˆ›å»ºæˆåŠŸ', 'success');
                    log('createLog', 'è¿”å›æ•°æ®: ' + JSON.stringify(result, null, 2));
                    testResults.create = result;
                } else {
                    log('createLog', 'ç›¸å†Œåˆ›å»ºå¤±è´¥: ' + responseText, 'error');
                    testResults.create = null;
                }
            } catch (error) {
                log('createLog', 'åˆ›å»ºç›¸å†Œå¼‚å¸¸: ' + error.message, 'error');
                testResults.create = null;
            }
        }

        async function loadFromAPI() {
            const logEl = document.getElementById('loadLog');
            logEl.textContent = '';
            
            if (!testResults.auth) {
                log('loadLog', 'è¯·å…ˆé€šè¿‡è®¤è¯æ£€æŸ¥', 'error');
                return;
            }
            
            log('loadLog', 'ä»ç®¡ç†APIè¯»å–ç›¸å†Œ...');
            
            try {
                const response = await fetch(`${API_BASE}/images`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                
                log('loadLog', `å“åº”çŠ¶æ€: ${response.status}`);
                
                const responseText = await response.text();
                log('loadLog', `å“åº”æ–‡æœ¬: ${responseText}`);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('loadLog', 'ç®¡ç†APIè¯»å–æˆåŠŸ', 'success');
                    log('loadLog', `æ‰¾åˆ° ${result.images ? result.images.length : 0} ä¸ªç›¸å†Œ`);
                    testResults.load = result;
                } else {
                    log('loadLog', 'ç®¡ç†APIè¯»å–å¤±è´¥: ' + responseText, 'error');
                    testResults.load = null;
                }
            } catch (error) {
                log('loadLog', 'ç®¡ç†APIè¯»å–å¼‚å¸¸: ' + error.message, 'error');
                testResults.load = null;
            }
        }

        async function loadFromPublicAPI() {
            const logEl = document.getElementById('loadLog');
            
            log('loadLog', 'ä»å…¬å¼€APIè¯»å–ç›¸å†Œ...');
            
            try {
                const response = await fetch(`${API_BASE}/api/content`);
                
                log('loadLog', `å…¬å¼€APIå“åº”çŠ¶æ€: ${response.status}`);
                
                const responseText = await response.text();
                log('loadLog', `å…¬å¼€APIå“åº”æ–‡æœ¬: ${responseText.substring(0, 500)}...`);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('loadLog', 'å…¬å¼€APIè¯»å–æˆåŠŸ', 'success');
                    log('loadLog', `æ‰¾åˆ° ${result.images ? result.images.length : 0} ä¸ªç›¸å†Œ`);
                    testResults.publicAPI = result;
                } else {
                    log('loadLog', 'å…¬å¼€APIè¯»å–å¤±è´¥: ' + responseText, 'error');
                    testResults.publicAPI = null;
                }
            } catch (error) {
                log('loadLog', 'å…¬å¼€APIè¯»å–å¼‚å¸¸: ' + error.message, 'error');
                testResults.publicAPI = null;
            }
        }

        async function compareData() {
            const logEl = document.getElementById('loadLog');
            
            if (!testResults.load || !testResults.publicAPI) {
                log('loadLog', 'è¯·å…ˆåˆ†åˆ«ä»ç®¡ç†APIå’Œå…¬å¼€APIè¯»å–æ•°æ®', 'warning');
                return;
            }
            
            log('loadLog', 'å¯¹æ¯”æ•°æ®...');
            
            const adminAlbums = testResults.load.images || [];
            const publicAlbums = testResults.publicAPI.images || [];
            
            log('loadLog', `ç®¡ç†API: ${adminAlbums.length} ä¸ªç›¸å†Œ`);
            log('loadLog', `å…¬å¼€API: ${publicAlbums.length} ä¸ªç›¸å†Œ`);
            
            if (adminAlbums.length === publicAlbums.length) {
                log('loadLog', 'æ•°æ®æ•°é‡ä¸€è‡´', 'success');
            } else {
                log('loadLog', 'æ•°æ®æ•°é‡ä¸ä¸€è‡´', 'warning');
            }
            
            updateDataAnalysis();
        }

        async function testAllEndpoints() {
            const logEl = document.getElementById('apiLog');
            logEl.textContent = '';
            
            const endpoints = [
                { url: `${API_BASE}/auth`, method: 'GET', auth: false },
                { url: `${API_BASE}/content`, method: 'GET', auth: true },
                { url: `${API_BASE}/images`, method: 'GET', auth: true },
                { url: `${API_BASE}/api/content`, method: 'GET', auth: false },
                { url: `${API_BASE}/upload`, method: 'GET', auth: true }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const headers = {};
                    if (endpoint.auth) {
                        headers['Authorization'] = `Bearer ${localStorage.getItem('authToken')}`;
                    }
                    
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: headers
                    });
                    
                    log('apiLog', `${endpoint.method} ${endpoint.url}: ${response.status}`);
                } catch (error) {
                    log('apiLog', `${endpoint.method} ${endpoint.url}: ERROR - ${error.message}`, 'error');
                }
            }
        }

        async function testKVOperations() {
            const logEl = document.getElementById('apiLog');
            
            log('apiLog', 'æµ‹è¯•KVæ“ä½œ...');
            log('apiLog', 'æ³¨æ„: è¿™éœ€è¦åœ¨Workerä¸­æ·»åŠ ä¸“é—¨çš„è°ƒè¯•ç«¯ç‚¹');
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šKVç›¸å…³çš„æµ‹è¯•
        }

        async function clearAllTestData() {
            const logEl = document.getElementById('apiLog');
            logEl.textContent = '';
            
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
                return;
            }
            
            if (!testResults.auth) {
                log('apiLog', 'è¯·å…ˆé€šè¿‡è®¤è¯æ£€æŸ¥', 'error');
                return;
            }
            
            // å…ˆè·å–æ‰€æœ‰ç›¸å†Œ
            try {
                const response = await fetch(`${API_BASE}/images`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const albums = result.images || [];
                    
                    log('apiLog', `æ‰¾åˆ° ${albums.length} ä¸ªç›¸å†Œ`);
                    
                    // åˆ é™¤åŒ…å«"è°ƒè¯•"æˆ–"æµ‹è¯•"çš„ç›¸å†Œ
                    for (const album of albums) {
                        if (album.title.includes('è°ƒè¯•') || album.title.includes('æµ‹è¯•') || album.category.includes('è°ƒè¯•')) {
                            try {
                                const deleteResponse = await fetch(`${API_BASE}/images/${album.id}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                                });
                                
                                if (deleteResponse.ok) {
                                    log('apiLog', `åˆ é™¤ç›¸å†Œ: ${album.title}`, 'success');
                                } else {
                                    log('apiLog', `åˆ é™¤å¤±è´¥: ${album.title}`, 'error');
                                }
                            } catch (error) {
                                log('apiLog', `åˆ é™¤å¼‚å¸¸: ${album.title} - ${error.message}`, 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                log('apiLog', 'æ¸…ç†æ•°æ®å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        function updateDataAnalysis() {
            const container = document.getElementById('dataAnalysis');
            
            let html = '<h3>ğŸ“Š æµ‹è¯•ç»“æœåˆ†æ</h3>';
            
            html += '<div class="step">';
            html += '<h4>è®¤è¯çŠ¶æ€</h4>';
            html += `<p>çŠ¶æ€: ${testResults.auth ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</p>`;
            html += '</div>';
            
            html += '<div class="step">';
            html += '<h4>ç›¸å†Œåˆ›å»º</h4>';
            html += `<p>çŠ¶æ€: ${testResults.create ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</p>`;
            if (testResults.create) {
                html += `<p>ç›¸å†ŒID: ${testResults.create.album ? testResults.create.album.id : 'N/A'}</p>`;
            }
            html += '</div>';
            
            html += '<div class="step">';
            html += '<h4>æ•°æ®è¯»å–</h4>';
            html += `<p>ç®¡ç†API: ${testResults.load ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</p>`;
            html += `<p>å…¬å¼€API: ${testResults.publicAPI ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</p>`;
            if (testResults.load && testResults.publicAPI) {
                const adminCount = testResults.load.images ? testResults.load.images.length : 0;
                const publicCount = testResults.publicAPI.images ? testResults.publicAPI.images.length : 0;
                html += `<p>æ•°æ®ä¸€è‡´æ€§: ${adminCount === publicCount ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}</p>`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è®¤è¯
        window.onload = function() {
            checkAuth();
        };
    </script>
</body>
</html> 